<html layout:decorate="~{layouts/no-sidebar-layout}" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
    <title>ƒê∆°n h√†ng - B·∫øp</title>
    <style>
        .order-card {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .badge-status {
            font-size: 0.9rem;
        }

        .list-group-item-new {
            background-color: white;
        }

        .list-group-item-cooking {
            background-color: gold;
        }

        .list-group-item-ready {
            background-color: springgreen;
        }

        .list-group-item-served {
            background-color: #e2e3e5;
        }

        .item-canceled {
            background-color: #f8d7da !important; /* n·ªÅn ƒë·ªè nh·∫°t */
            color: #842029 !important; /* ch·ªØ ƒë·ªè ƒë·∫≠m */
            font-style: italic;
        }

        .btn-cancel {
            color: #842029;
            border: 1px solid #842029;
            background-color: #f8d7da;
        }

        .btn-cancel:hover {
            background-color: #e58d96;
            color: white;
            border-color: #842029;
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

</head>
<div layout:fragment="content">
    <h2 class="mb-4">M√≥n c·∫ßn ch·∫ø bi·∫øn</h2>
    <div th:if="${undoItemId != null}" class="alert alert-info alert-dismissible fade show" role="alert" id="undoAlert">
        ƒê√£ thay ƒë·ªïi tr·∫°ng th√°i m√≥n.
        <form th:action="@{'/kitchen/dashboard/item/' + ${undoItemId} + '/undo'}" method="post" style="display:inline;">
            <input type="hidden" name="status" th:value="${undoOldStatus}"/>
            <input type="hidden" name="filter" th:value="${undoFilter}"/>
            <input type="hidden" name="date" th:value="${undoDate}"/>
            <button type="submit" class="btn btn-link p-0 m-0 align-baseline">Ho√†n t√°c</button>
        </form>
    </div>

    <form class="mb-3 d-flex align-items-center gap-2" method="get" th:action="@{/kitchen/dashboard}">
        <input type="hidden" name="filter" th:value="${currentFilter}"/>
        <label for="date" class="form-label mb-0">Ng√†y:</label>
        <input type="date" id="date" name="date"
               th:value="${selectedDate}" class="form-control" style="max-width: 200px;" onchange="this.form.submit()"/>

    </form>


    <!-- Tabs l·ªçc tr·∫°ng th√°i -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link"
               th:classappend="${currentFilter == 'ALL'} ? 'active'"
               th:href="@{/kitchen/dashboard(filter='ALL', date=${currentDate})}">
                T·∫•t c·∫£
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link"
               th:classappend="${currentFilter == 'NEW'} ? 'active'"
               th:href="@{/kitchen/dashboard(filter='NEW', date=${currentDate})}">
                Ch∆∞a b·∫Øt ƒë·∫ßu
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link"
               th:classappend="${currentFilter == 'COOKING'} ? 'active'"
               th:href="@{/kitchen/dashboard(filter='COOKING', date=${currentDate})}">
                ƒêang ch·∫ø bi·∫øn
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link"
               th:classappend="${currentFilter == 'READY'} ? 'active'"
               th:href="@{/kitchen/dashboard(filter='READY', date=${currentDate})}">
                ƒê√£ s·∫µn s√†ng
            </a>
        </li>
    </ul>
    <!-- Giao di·ªán c√°c nh√≥m ƒë∆°n h√†ng -->
    <div class="row" id="order-container">
        <div class="col-12 col-md-6 mb-4" th:each="group : ${groupedOrders}" th:if="${group.hasUnservedItems()}">
            <div class="order-card bg-white d-flex flex-column justify-content-between">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong th:text="'B√†n ' + ${group.tableName}">B√†n 01</strong> |
                        <small th:text="${#temporals.format(group.createdAt, 'HH:mm dd/MM/yyyy')}">12:00</small>
                    </div>
                </div>

                <!-- Danh s√°ch m√≥n -->
                <ul class="list-group">
                    <li class="list-group-item"
                        th:each="item : ${group.orderItems}"
                        th:if="${item.deleted == false}"
                        th:classappend="'list-group-item-' + ${item.status.name().toLowerCase()} + (${item.status.name() == 'CANCELED'} ? ' item-canceled' : '')"
                        th:attr="data-item-id=${item.id}">


                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>
                                    <span th:text="${item.menuItem.name}"></span>
                                    <span th:if="${item.status.name() == 'CANCELED'}">(ƒê√£ hu·ª∑)</span>
                                </strong>

                                <span class="badge bg-primary rounded-pill" th:text="'x' + ${item.quantity}">x1</span>
                            </div>
                            <form th:action="@{'/kitchen/dashboard/item/' + ${item.id} + '/status'}" method="post"
                                  onsubmit="playNotify()">
                                <input type="hidden" name="date" th:value="${currentDate}"/>
                                <input type="hidden" name="filter" th:value="${currentFilter}"/>

                                <input type="hidden" name="status" th:if="${item.status.name() == 'NEW'}"
                                       value="COOKING"/>
                                <input type="hidden" name="status" th:if="${item.status.name() == 'COOKING'}"
                                       value="READY"/>
                                <input type="hidden" name="status" th:if="${item.status.name() == 'READY'}"
                                       value="SERVED"/>

                                <button type="submit" th:if="${item.status.name() == 'NEW'}"
                                        class="btn btn-outline-warning btn-sm">B·∫Øt ƒë·∫ßu
                                </button>
                                <button type="submit" th:if="${item.status.name() == 'COOKING'}"
                                        class="btn btn-outline-success btn-sm">S·∫µn s√†ng
                                </button>
                                <button type="submit" th:if="${item.status.name() == 'READY'}"
                                        class="btn btn-success btn-sm">ƒê√£ s·∫µn s√†ng
                                </button>
                            </form>
                            <form th:action="@{'/kitchen/hide/orderItem'}" method="post"
                                  th:if="${item.deleted == false and item.status.name() == 'CANCELED'}">
                                <input type="hidden" name="orderId" th:value="${item.id}"/>
                                <input type="hidden" name="date" th:value="${currentDate}"/>
                                <input type="hidden" name="filter" th:value="${currentFilter}"/>
                                <input type="submit" value="·∫®n" class="btn btn-cancel btn-sm">
                            </form>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="modal">
    <audio id="notifySound" src="https://www.myinstants.com/media/sounds/bell-notification.mp3" preload="auto"></audio>
</th:block>

<th:block layout:fragment="script">
    <script>
        function playNotify() {
            document.getElementById("notifySound").play();
        }

        setTimeout(() => {
            const alert = document.getElementById("undoAlert");
            if (alert) {
                alert.classList.remove("show");
                alert.classList.add("hide");
            }
        }, 3000);
    </script>
    <script>
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            stompClient.subscribe(`/topic/user.${empId}`, function (message) {
                let data = JSON.parse(message.body);
                console.log("üì© Notification nh·∫≠n:", data);
                if (data.newOrder) {
                    appendNewOrderToDOM(data);
                } else {
                    const item = data.orderItem;
                    if (item && item.status === "CANCELED") {
                        updateCanceledItem(item);
                    } else if (item.status === "SERVED") {
                        updateServedItem(item);
                    }
                }
            });
        });

        function appendNewOrderToDOM(data) {
            const container = document.getElementById("order-container");
            const order = data.order;
            const tableName = order.table.name; // V√≠ d·ª•: "B√†n 7"
            const createdAt = new Date(order.createdAt);

            // T·∫°o c·ªôt ngo√†i
            const col = document.createElement("div");
            col.className = "col-12 col-md-6 mb-4";

            // T·∫°o kh·ªëi order-card
            const card = document.createElement("div");
            card.className = "order-card bg-white d-flex flex-column justify-content-between";

            // Ph·∫ßn header (t√™n b√†n + th·ªùi gian)
            const headerDiv = document.createElement("div");
            headerDiv.className = "d-flex justify-content-between align-items-center mb-2";

            const infoDiv = document.createElement("div");
            const strong = document.createElement("strong");
            strong.textContent = tableName;

            const small = document.createElement("small");
            small.textContent = createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + " " +
                createdAt.toLocaleDateString("vi-VN");

            infoDiv.appendChild(strong);
            infoDiv.appendChild(document.createTextNode(" | "));
            infoDiv.appendChild(small);
            headerDiv.appendChild(infoDiv);

            card.appendChild(headerDiv);

            // Danh s√°ch m√≥n ƒÉn
            const ul = document.createElement("ul");
            ul.className = "list-group";

            data.orderItems.forEach(item => {
                const li = document.createElement("li");
                li.className = `list-group-item list-group-item-${item.status.toLowerCase()}`;
                if (item.status === "CANCELED") {
                    li.classList.add("item-canceled");
                }
                li.setAttribute("data-item-id", item.id);

                const contentDiv = document.createElement("div");
                contentDiv.className = "d-flex justify-content-between";

                const leftDiv = document.createElement("div");
                const itemName = document.createElement("strong");
                itemName.textContent = item.menuItem.name;
                if (item.status === "CANCELED") {
                    itemName.textContent += " (ƒê√£ hu·ª∑)";
                }

                const badge = document.createElement("span");
                badge.className = "badge bg-primary rounded-pill";
                badge.textContent = "x" + item.quantity;

                leftDiv.appendChild(itemName);
                leftDiv.appendChild(document.createTextNode(" "));
                leftDiv.appendChild(badge);

                const form = document.createElement("form");
                form.method = "post";
                form.action = `/kitchen/dashboard/item/${item.id}/status`;
                form.onsubmit = () => { playNotify(); };

                const hiddenDate = document.createElement("input");
                hiddenDate.type = "hidden";
                hiddenDate.name = "date";
                hiddenDate.value = new Date().toISOString().split("T")[0]; // ho·∫∑c gi√° tr·ªã b·∫°n c·∫ßn

                const hiddenFilter = document.createElement("input");
                hiddenFilter.type = "hidden";
                hiddenFilter.name = "filter";
                hiddenFilter.value = ""; // C·∫≠p nh·∫≠t n·∫øu c√≥ gi√° tr·ªã filter hi·ªán t·∫°i

                const hiddenStatus = document.createElement("input");
                hiddenStatus.type = "hidden";
                hiddenStatus.name = "status";

                let button;
                if (item.status === "NEW") {
                    hiddenStatus.value = "COOKING";
                    button = createStatusButton("B·∫Øt ƒë·∫ßu", "btn-outline-warning");
                } else if (item.status === "COOKING") {
                    hiddenStatus.value = "READY";
                    button = createStatusButton("S·∫µn s√†ng", "btn-outline-success");
                } else if (item.status === "READY") {
                    hiddenStatus.value = "SERVED";
                    button = createStatusButton("ƒê√£ s·∫µn s√†ng", "btn-success");
                }

                form.appendChild(hiddenDate);
                form.appendChild(hiddenFilter);
                form.appendChild(hiddenStatus);
                if (button) form.appendChild(button);

                contentDiv.appendChild(leftDiv);
                contentDiv.appendChild(form);

                li.appendChild(contentDiv);
                ul.appendChild(li);
            });

            card.appendChild(ul);
            col.appendChild(card);
            container.appendChild(col); // ch√®n v√†o cu·ªëi
        }

        function createStatusButton(text, btnClass) {
            const button = document.createElement("button");
            button.type = "submit";
            button.className = `btn ${btnClass} btn-sm`;
            button.textContent = text;
            return button;
        }

        function updateCanceledItem(orderItem) {
            const itemId = orderItem.id;
            const listItem = document.querySelector(`li[data-item-id="${itemId}"]`);

            if (!listItem) {
                console.warn(`Item ${itemId} not found in DOM.`);
                return;
            }

            // 1. C·∫≠p nh·∫≠t class tr·∫°ng th√°i
            listItem.classList.remove(
                "list-group-item-new",
                "list-group-item-warning",
                "list-group-item-success",
                "list-group-item-info"
            );
            listItem.classList.add("list-group-item-canceled", "item-canceled");

            // 2. C·∫≠p nh·∫≠t n·ªôi dung m√≥n ƒÉn v·ªõi (ƒê√£ hu·ª∑)
            const strongEl = listItem.querySelector("strong");
            if (strongEl) {
                const spanEls = strongEl.querySelectorAll("span");
                const nameSpan = spanEls[0];

                // Ki·ªÉm tra v√† th√™m "(ƒê√£ hu·ª∑)" n·∫øu ch∆∞a c√≥
                if (!strongEl.innerHTML.includes("(ƒê√£ hu·ª∑)")) {
                    const canceledSpan = document.createElement("span");
                    canceledSpan.textContent = " (ƒê√£ hu·ª∑)";
                    strongEl.appendChild(canceledSpan);
                }
            }

            // 3. Xo√° form thay ƒë·ªïi tr·∫°ng th√°i (n√∫t B·∫Øt ƒë·∫ßu, Ho√†n t·∫•t...)
            const statusForms = listItem.querySelectorAll("form");
            statusForms.forEach(form => {
                const hasStatusInput = form.querySelector('input[name="status"]');
                if (hasStatusInput) {
                    form.remove(); // ch·ªâ xo√° form thay ƒë·ªïi tr·∫°ng th√°i
                }
            });

            // 4. Th√™m form ·∫®n n·∫øu ch∆∞a c√≥
            const hasHideForm = Array.from(listItem.querySelectorAll("form")).some(
                form => form.action.includes("/hide/orderItem")
            );

            if (!hasHideForm) {
                const hideForm = document.createElement("form");
                hideForm.action = "/kitchen/hide/orderItem";
                hideForm.method = "post";

                const today = new Date().toISOString().slice(0, 10); // yyyy-mm-dd

                hideForm.innerHTML = `
                    <input type="hidden" name="orderId" value="${orderItem.id}">
                    <input type="hidden" name="date" value="${today}">
                    <input type="hidden" name="filter" value="ALL">
                    <input type="submit" value="·∫®n" class="btn btn-cancel btn-sm">
                `;

                const flexContainer = listItem.querySelector(".d-flex");
                if (flexContainer) {
                    flexContainer.appendChild(hideForm);
                }
            }
        }

        function updateServedItem(orderItem) {
            const itemId = orderItem.id;
            const listItem = document.querySelector(`li[data-item-id="${itemId}"]`);

            if (!listItem) {
                console.warn(`Item ${itemId} not found in DOM.`);
                return;
            }

            // 1. C·∫≠p nh·∫≠t class tr·∫°ng th√°i
            listItem.classList.remove(
                "list-group-item-new",
                "list-group-item-warning",
                "list-group-item-success",
                "list-group-item-info",
                "list-group-item-canceled"
            );
            listItem.classList.add("list-group-item-served");

            // 3. C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng m√≥n (badge)
            const badge = listItem.querySelector(".badge");
            if (badge) {
                badge.textContent = `x${orderItem.quantity}`;
            }

            // 4. L√†m r·ªóng v√† reset l·∫°i <form> (·∫©n c√°c n√∫t thao t√°c)
            const form = listItem.querySelector("form");
            if (form) {
                form.innerHTML = "";

                // Gi·ªØ l·∫°i action v√† method
                form.setAttribute("action", `/kitchen/dashboard/item/${itemId}/status`);
                form.setAttribute("method", "post");

                // Hidden input date v√† filter (gi√° tr·ªã c√≥ th·ªÉ l·∫•y t·ª´ bi·∫øn to√†n c·ª•c n·∫øu c·∫ßn)
                const today = new Date().toISOString().slice(0, 10);
                form.innerHTML += `
            <input type="hidden" name="date" value="${today}">
            <input type="hidden" name="filter" value="ALL">
        `;
            }
        }


    </script>
</th:block>
</html>
