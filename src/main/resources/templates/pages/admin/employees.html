<html layout:decorate="~{layouts/main-layout}" xmlns:layout="http://www.thymeleaf.org">
    <head>
        <title>Nhân viên - Admin</title>
    <style>
        .invalid-feedback {
            display: block !important;
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .form-control.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        
        .form-select.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
    </style>
    <script>
        function toggleEmployeeStatus(employeeId) {
            document.getElementById('toggleEmployeeId').value = employeeId;
            var modal = new bootstrap.Modal(document.getElementById('toggleStatusModal'));
            modal.show();
        }

        function confirmToggleStatus() {
            var employeeId = document.getElementById('toggleEmployeeId').value;
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/employees/toggle-status';
            
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'employeeId';
            input.value = employeeId;
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function editEmployee(id) {
            // Tìm employee trong danh sách
            const employeeRow = document.querySelector(`tr[data-employee-id="${id}"]`);
            if (employeeRow) {
                const name = employeeRow.querySelector('td:nth-child(2)').textContent.trim();
                const username = employeeRow.querySelector('td:nth-child(3)').textContent.trim();
                const email = employeeRow.querySelector('td:nth-child(4)').textContent.trim();
                const roleName = employeeRow.querySelector('td:nth-child(5) .badge').textContent.trim();
                
                // Tìm role ID dựa trên role name
                const roleSelect = document.getElementById('editRoleId');
                let roleId = '';
                for (let option of roleSelect.options) {
                    if (option.textContent.trim() === roleName) {
                        roleId = option.value;
                        break;
                    }
                }
                
                // Điền dữ liệu vào form
                document.getElementById('editEmployeeId').value = id;
                document.getElementById('editName').value = name;
                document.getElementById('editUsername').value = username;
                document.getElementById('editEmail').value = email;
                document.getElementById('editRoleId').value = roleId;
                document.getElementById('editPassword').value = ''; // Reset password field
                
                // Cập nhật action URL
                document.getElementById('editEmployeeForm').action = `/admin/employees/${id}/update`;
                
                var modal = new bootstrap.Modal(document.getElementById('editEmployeeModal'));
                modal.show();
            }
        }

        function deleteEmployee(id) {
            // Tìm employee trong danh sách để kiểm tra trạng thái
            const employeeRow = document.querySelector(`tr[data-employee-id="${id}"]`);
            if (employeeRow) {
                const status = employeeRow.querySelector('td:nth-child(7) .badge').textContent.trim();
                const roleName = employeeRow.querySelector('td:nth-child(5) .badge').textContent.trim();
                
                // Kiểm tra xem có phải admin không
                if (roleName === 'QUẢN_TRỊ') {
                    document.getElementById('errorModalMessage').textContent = 'Không thể xóa tài khoản quản trị!';
                    var errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                    errorModal.show();
                    return;
                }
                
                // Kiểm tra xem tài khoản có đang kích hoạt không
                if (status === 'Đã kích hoạt') {
                    document.getElementById('errorModalMessage').textContent = 'Không thể xóa tài khoản đang kích hoạt. Vui lòng vô hiệu hóa trước!';
                    var errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                    errorModal.show();
                    return;
                }
                
                // Điền ID vào form và hiển thị modal
                document.getElementById('deleteEmployeeId').value = id;
                document.getElementById('deleteEmployeeForm').action = `/admin/employees/${id}/delete`;
                
                var modal = new bootstrap.Modal(document.getElementById('deleteEmployeeModal'));
                modal.show();
            }
        }



        function showSuccessMessage(message) {
            var alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            var contentDiv = document.querySelector('[layout\\:fragment="content"]');
            contentDiv.insertBefore(alertDiv, contentDiv.firstChild);

            setTimeout(function() {
                var bsAlert = new bootstrap.Alert(alertDiv);
                bsAlert.close();
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            var alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    var bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
            
            // AJAX validation
            const addForm = document.getElementById('addEmployeeForm');
            const editForm = document.getElementById('editEmployeeForm');
            
            // Validation cho form thêm mới
            if (addForm) {
                addForm.addEventListener('submit', function(e) {
                    if (!validateFormWithAjax(addForm)) {
                        e.preventDefault();
                    }
                });
                
                // Validation real-time khi blur
                addForm.querySelectorAll('input, select').forEach(function(field) {
                    field.addEventListener('blur', function() {
                        validateFieldWithAjax(this, 'add');
                    });
                });
            }
            
            // Validation cho form chỉnh sửa
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    if (!validateFormWithAjax(editForm)) {
                        e.preventDefault();
                    }
                });
                
                // Validation real-time khi blur
                editForm.querySelectorAll('input, select').forEach(function(field) {
                    field.addEventListener('blur', function() {
                        const employeeId = document.getElementById('editEmployeeId').value;
                        validateFieldWithAjax(this, 'edit', employeeId);
                    });
                });
            }
            
            function validateFieldWithAjax(field, formType, employeeId = null) {
                const fieldName = field.name;
                const value = field.value.trim();
                
                // Nếu field trống, validate cơ bản trước
                if (!value && fieldName !== 'password') {
                    showFieldError(field, getFieldRequiredMessage(fieldName));
                    return;
                }
                
                // Nếu password trống trong form edit, không cần validate
                if (fieldName === 'password' && !value && formType === 'edit') {
                    clearFieldError(field);
                    return;
                }
                
                // Tạo data để gửi AJAX
                const data = {
                    fieldName: fieldName,
                    value: value,
                    formType: formType
                };
                
                if (employeeId) {
                    data.employeeId = employeeId;
                }
                
                // Gửi AJAX request
                fetch('/admin/employees/validate-field', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.valid) {
                        clearFieldError(field);
                    } else {
                        showFieldError(field, result.message);
                    }
                })
                .catch(error => {
                    console.error('Validation error:', error);
                    // Fallback to basic validation
                    validateFieldBasic(field, fieldName, value, formType);
                });
            }
            
            function validateFieldBasic(field, fieldName, value, formType) {
                // Basic validation fallback
                if (fieldName === 'name') {
                    if (!value) {
                        showFieldError(field, 'Họ tên không được để trống');
                    } else if (value.length < 2) {
                        showFieldError(field, 'Họ tên phải có ít nhất 2 ký tự');
                    } else if (!/^[a-zA-ZÀ-ỹ\s]+$/.test(value)) {
                        showFieldError(field, 'Họ tên chỉ được chứa chữ cái và khoảng trắng');
                    } else {
                        clearFieldError(field);
                    }
                } else if (fieldName === 'username') {
                    if (!value) {
                        showFieldError(field, 'Tên đăng nhập không được để trống');
                    } else if (value.length < 3 || value.length > 50) {
                        showFieldError(field, 'Tên đăng nhập phải từ 3-50 ký tự');
                    } else if (!/^[a-zA-Z0-9_]+$/.test(value)) {
                        showFieldError(field, 'Tên đăng nhập chỉ được chứa chữ cái, số và dấu gạch dưới');
                    } else {
                        clearFieldError(field);
                    }
                } else if (fieldName === 'email') {
                    if (!value) {
                        showFieldError(field, 'Email không được để trống');
                    } else if (!/^\w+@[a-z]{5,7}(\.[a-z]{2,3}){1,2}$/.test(value)) {
                        showFieldError(field, 'Email không đúng định dạng');
                    } else {
                        clearFieldError(field);
                    }
                } else if (fieldName === 'password') {
                    // Trong form add, password không cần validate
                    if (formType === 'add') {
                        clearFieldError(field);
                    } else if (value && value.length < 6) {
                        showFieldError(field, 'Mật khẩu phải có ít nhất 6 ký tự');
                    } else if (value && !/^[a-z0-9]+$/.test(value)) {
                        showFieldError(field, 'Mật khẩu chỉ được chứa chữ thường và số');
                    } else {
                        clearFieldError(field);
                    }
                } else if (fieldName === 'roleId') {
                    if (!value) {
                        showFieldError(field, 'Vui lòng chọn vai trò');
                    } else {
                        clearFieldError(field);
                    }
                }
            }
            
            function getFieldRequiredMessage(fieldName) {
                const messages = {
                    'name': 'Họ tên không được để trống',
                    'username': 'Tên đăng nhập không được để trống',
                    'email': 'Email không được để trống',
                    'password': '',
                    'roleId': 'Vui lòng chọn vai trò'
                };
                return messages[fieldName] || 'Trường này không được để trống';
            }
            
            function validateFormWithAjax(form) {
                let isValid = true;
                const formType = form.id === 'addEmployeeForm' ? 'add' : 'edit';
                const employeeId = formType === 'edit' ? document.getElementById('editEmployeeId').value : null;
                
                // Validate tất cả các field
                const fields = form.querySelectorAll('input, select');
                let validationPromises = [];
                
                fields.forEach(function(field) {
                    const fieldName = field.name;
                    const value = field.value.trim();
                    
                    // Skip empty password in edit form
                    if (fieldName === 'password' && !value && formType === 'edit') {
                        return;
                    }
                    
                    // Create validation promise
                    const promise = validateFieldAsync(field, formType, employeeId);
                    validationPromises.push(promise);
                });
                
                // Wait for all validations to complete
                Promise.all(validationPromises).then(() => {
                    // Check if any field has errors
                    const hasErrors = form.querySelectorAll('.is-invalid').length > 0;
                    if (!hasErrors) {
                        form.submit();
                    }
                });
                
                return false; // Prevent default submit, let AJAX handle it
            }
            
            function validateFieldAsync(field, formType, employeeId) {
                return new Promise((resolve) => {
                    validateFieldWithAjax(field, formType, employeeId);
                    // Add a small delay to allow AJAX to complete
                    setTimeout(() => resolve(), 100);
                });
            }
            
            function showFieldError(field, message) {
                field.classList.add('is-invalid');
                let errorDiv = field.parentNode.querySelector('.invalid-feedback');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback';
                    field.parentNode.appendChild(errorDiv);
                }
                errorDiv.textContent = message;
            }
            
            function clearFieldError(field) {
                field.classList.remove('is-invalid');
                const errorDiv = field.parentNode.querySelector('.invalid-feedback');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }
        });
    </script>
</head>
<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
            <i class="bi bi-plus-circle me-2"></i>Thêm nhân viên
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped shadow-sm rounded bg-white">
                    <thead class="table-dark text-center">
                        <tr>
                            <th class="text-center">ID</th>
                            <th class="text-center">Họ tên</th>
                            <th class="text-center">Tên đăng nhập</th>
                            <th class="text-center">Email</th>
                            <th class="text-center">Vai trò</th>
                            <th class="text-center">Ngày tạo</th>
                            <th class="text-center">Trạng thái</th>
                            <th class="text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody class="align-middle text-center">
                        <tr th:each="employee : ${employees}" th:attr="data-employee-id=${employee.id}">
                            <td th:text="${employee.id}">1</td>
                            <td th:text="${employee.name}">Nguyễn Văn A</td>
                            <td th:text="${employee.username}">nv1</td>
                            <td th:text="${employee.email}">email@example.com</td>
                            <td>
                                <span class="badge" 
                                      th:classappend="${employee.role.name == 'QUẢN_LÝ' ? 'bg-success' : (employee.role.name == 'THU_NGÂN' ? 'bg-warning' : (employee.role.name == 'PHỤC_VỤ' ? 'bg-info' : (employee.role.name == 'BẾP' ? 'bg-danger' : (employee.role.name == 'QUẢN_TRỊ' ? 'bg-dark' : 'bg-secondary'))))}"
                                      th:text="${employee.role.name}">Vai trò</span>
                            </td>
                            <td th:text="${#temporals.format(employee.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2024</td>
                            <td>
                                <span class="badge" 
                                      th:classappend="${employee.enable ? 'bg-success' : 'bg-danger'}"
                                      th:text="${employee.enable ? 'Đã kích hoạt' : 'Chưa kích hoạt'}">Trạng thái</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" 
                                        th:onclick="'editEmployee(' + ${employee.id} + ')'">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm" 
                                        th:classappend="${employee.enable ? 'btn-outline-warning' : 'btn-outline-success'}"
                                        th:onclick="'toggleEmployeeStatus(' + ${employee.id} + ')'"
                                        th:title="${employee.enable ? 'Vô hiệu hóa tài khoản' : 'Kích hoạt tài khoản'}">
                                    <i class="bi" th:classappend="${employee.enable ? 'bi-toggle-on' : 'bi-toggle-off'}"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        th:onclick="'deleteEmployee(' + ${employee.id} + ')'">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal fade" id="addEmployeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm nhân viên mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addEmployeeForm" action="/admin/employees/add" method="post" th:object="${employeeDTO}">
                        <div class="mb-3">
                            <label for="name" class="form-label">Họ tên</label>
                            <input type="text" class="form-control" id="name" name="name" th:field="*{name}">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                        </div>
                        <div class="mb-3">
                            <label for="username" class="form-label">Tên đăng nhập</label>
                            <input type="text" class="form-control" id="username" name="username" th:field="*{username}">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" th:field="*{email}">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="roleId" class="form-label">Vai trò</label>
                            <select class="form-select" id="roleId" name="roleId" th:field="*{roleId}">
                                <option value="">Chọn vai trò</option>
                                <option th:each="role : ${roles}" th:value="${role.id}" th:text="${role.name}" th:if="${role.name != 'QUẢN_TRỊ'}">Vai trò</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('roleId')}" th:errors="*{roleId}"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" form="addEmployeeForm" class="btn btn-primary">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div class="modal fade" id="editEmployeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa nhân viên</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editEmployeeForm" method="post">
                        <input type="hidden" id="editEmployeeId" name="id">
                        <div class="mb-3">
                            <label for="editName" class="form-label">Họ tên</label>
                            <input type="text" class="form-control" id="editName" name="name">
                            <div class="invalid-feedback" id="editNameError"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editUsername" class="form-label">Tên đăng nhập</label>
                            <input type="text" class="form-control" id="editUsername" name="username">
                            <div class="invalid-feedback" id="editUsernameError"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" name="email">
                            <div class="invalid-feedback" id="editEmailError"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword" class="form-label">Mật khẩu mới</label>
                            <input type="password" class="form-control" id="editPassword" name="password" placeholder="Nhập mật khẩu mới (để trống nếu không đổi)">
                            <div class="invalid-feedback" id="editPasswordError"></div>
                            <small class="form-text text-muted">Mật khẩu phải có ít nhất 6 ký tự, chỉ chứa chữ thường và số</small>
                        </div>
                        <div class="mb-3">
                            <label for="editRoleId" class="form-label">Vai trò</label>
                            <select class="form-select" id="editRoleId" name="roleId">
                                <option value="">Chọn vai trò</option>
                                <option th:each="role : ${roles}" th:value="${role.id}" th:text="${role.name}" th:if="${role.name != 'QUẢN_TRỊ'}">Vai trò</option>
                            </select>
                            <div class="invalid-feedback" id="editRoleIdError"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" form="editEmployeeForm" class="btn btn-primary">Cập nhật</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteEmployeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận xóa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa nhân viên này?</p>
                    <p class="text-muted">Hành động này không thể hoàn tác.</p>
                    <form id="deleteEmployeeForm" method="post">
                        <input type="hidden" id="deleteEmployeeId" name="id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" form="deleteEmployeeForm" class="btn btn-danger">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toggle Status Confirmation Modal -->
    <div class="modal fade" id="toggleStatusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận thay đổi trạng thái</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="toggleStatusMessage">Bạn có chắc chắn muốn vô hiệu hóa tài khoản này?</p>
                    <input type="hidden" id="toggleEmployeeId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-warning" onclick="confirmToggleStatus()">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Lỗi
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="errorModalMessage" class="mb-0"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
</div>
</html> 