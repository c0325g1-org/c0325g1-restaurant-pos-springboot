<html layout:decorate="~{layouts/main-layout}" xmlns:layout="http://www.thymeleaf.org">
<head>
    <title>Manager Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        @media (max-width: 576px) {
            #revenue-form {
                flex-direction: column !important;
                align-items: stretch !important;
            }
        }
    </style>
</head>

<div layout:fragment="content">
    <!-- Các thống kê nhanh -->
    <div class="row g-4">
        <div class="col-sm-6 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-receipt" style="font-size: 2rem;"></i>
                    <h5 class="card-title mt-2">Hóa đơn hôm nay</h5>
                    <p class="card-text" th:text="${invoiceToday}">0</p>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-currency-dollar" style="font-size: 2rem;"></i>
                    <h5 class="card-title mt-2">Doanh thu hôm nay</h5>
                    <p class="card-text"
                       th:text="${#numbers.formatDecimal(revenueToday, 0, 'COMMA', 0, 'POINT')} + 'đ'">0đ</p>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-box-seam" style="font-size: 2rem;"></i>
                    <h5 class="card-title mt-2">Món đang bán</h5>
                    <p class="card-text" th:text="${sellingItems}">0</p>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-6 col-lg-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-people" style="font-size: 2rem;"></i>
                    <h5 class="card-title mt-2">Nhân viên</h5>
                    <p class="card-text" th:text="${enabledEmployees} + '/' + ${totalEmployees}">15/15</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Biểu đồ -->
    <div class="row mt-4 g-4">
        <!-- Biểu đồ cột doanh thu -->
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title mb-3">Biểu đồ doanh thu theo ngày</h5>
                    <form id="revenue-form" class="d-flex flex-column flex-sm-row gap-2 align-items-end mb-4">
                        <div class="flex-grow-1">
                            <label for="startDate" class="form-label mb-1">Từ ngày:</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="flex-grow-1">
                            <label for="endDate" class="form-label mb-1">Đến ngày:</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                        <div>
                            <button type="button" id="btn-search" class="btn btn-primary px-4">Xem biểu đồ</button>
                        </div>
                    </form>

                    <div style="position: relative; width: 100%; height: 320px;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Biểu đồ tròn món bán chạy -->
        <div class="col-md-4 d-flex justify-content-center">
            <div class="card shadow-sm h-100 w-100" style="max-width: 360px;">
                <div class="card-body d-flex flex-column align-items-center">
                    <h5 class="card-title mb-3 text-center">Biểu đồ món bán chạy trong tháng</h5>
                    <div class="ratio ratio-1x1 w-100">
                        <canvas id="topItemsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script -->
<th:block layout:fragment="script">
    <script th:inline="javascript">
        let chart;
        let topItemsChart;

        function formatDate(date) {
            let d = date.getDate();
            let m = date.getMonth() + 1;
            let y = date.getFullYear();
            if (d < 10) d = '0' + d;
            if (m < 10) m = '0' + m;
            return `${y}-${m}-${d}`;
        }

        function chartHandler() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const start = document.getElementById("startDate").value;
            const end = document.getElementById("endDate").value;

            if (!start || !end) {
                alert("Vui lòng chọn đầy đủ ngày bắt đầu và kết thúc.");
                return;
            }

            fetch(`/manager/revenue?start=${start}&end=${end}`)
                .then(response => {
                    if (!response.ok) throw new Error("Lỗi khi lấy dữ liệu doanh thu.");
                    return response.json();
                })
                .then(data => {
                    const labels = Object.keys(data);
                    const values = Object.values(data);

                    if (chart) chart.destroy();

                    chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Doanh thu (VNĐ)',
                                data: values,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: value => new Intl.NumberFormat('vi-VN').format(value) + ' đ'
                                    }
                                }
                            },
                            plugins: {
                                legend: { display: true }
                            },
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                })
                .catch(error => {
                    console.error(error);
                    alert("Đã có lỗi xảy ra khi hiển thị biểu đồ.");
                });
        }

        function loadTopItemsChart() {
            fetch("/manager/top-items")
                .then(response => {
                    if (!response.ok) throw new Error("Lỗi khi lấy dữ liệu món bán chạy.");
                    return response.json();
                })
                .then(data => {
                    const labels = Object.keys(data);
                    const values = Object.values(data);
                    const ctx = document.getElementById('topItemsChart').getContext('2d');

                    if (topItemsChart) topItemsChart.destroy();

                    topItemsChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Số lượng bán',
                                data: values,
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.6)',
                                    'rgba(54, 162, 235, 0.6)',
                                    'rgba(255, 206, 86, 0.6)',
                                    'rgba(75, 192, 192, 0.6)',
                                    'rgba(153, 102, 255, 0.6)',
                                    'rgba(255, 159, 64, 0.6)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => `${ctx.label}: ${ctx.parsed} món`
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error(error);
                    alert("Đã có lỗi khi tải biểu đồ món bán chạy.");
                });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            document.getElementById("startDate").value = formatDate(firstDay);
            document.getElementById("endDate").value = formatDate(lastDay);

            chartHandler();
            loadTopItemsChart();

            document.getElementById("btn-search").addEventListener("click", chartHandler);
        });
    </script>
</th:block>
</html>
