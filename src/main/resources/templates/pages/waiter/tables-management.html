<html layout:decorate="~{layouts/main-layout}" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
    <title>Bàn ăn - Phục vụ</title>
</head>
<div layout:fragment="content">
    <div class="row mb-3 g-3">
        <div class="col-md-3">
            <input id="tableSearch" type="text" class="form-control" placeholder="Tìm bàn..." oninput="filterTables()" />
        </div>
        <div class="col-md-3">
            <select id="statusFilter" class="form-select" onchange="filterTables()">
                <option value="">Tất cả trạng thái</option>
                <option value="EMPTY">Trống</option>
                <option value="RESERVED">Đặt trước</option>
                <option value="SERVING">Đang phục vụ</option>
            </select>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-6 col-md-3 table-card" th:each="table : ${tables}" th:attr="data-status=${table.status.name()}">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title" th:text="${table.name}"></h5>
                    <span class="badge"
                          th:class="${'badge ' +  (table.status.name() == 'EMPTY' ? 'bg-success' :
                          table.status.name() == 'RESERVED' ? 'bg-warning text-dark' : 'bg-danger')}"
                          th:text="${table.status}">
                    </span>

                    <button class="btn btn-sm btn-outline-secondary w-100 mt-2"
                            onclick="openStatusModal(this)"
                            th:attr="data-id=${table.id}, data-current=${table.status.name()}">
                        Cập nhật trạng thái
                    </button>

                    <button class="btn btn-sm btn-success w-100 mt-2" onclick="handleOrder(this)"
                            th:attr="data-id=${table.id}, data-status=${table.status.name()}">Gọi món</button>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="modal">
    <div class="modal fade" id="confirmServeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chuyển trạng thái bàn</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Bàn này chưa ở trạng thái "Đang phục vụ". Bạn có muốn chuyển sang để gọi món không?
                </div>
                <div class="modal-footer">
                    <form id="serveForm" method="post">
                        <input type="hidden" name="status" value="SERVING">
                        <button type="submit" class="btn btn-primary">Đồng ý</button>
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="statusForm" method="post" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cập nhật trạng thái bàn</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Chọn trạng thái mới cho bàn:</p>
                    <input type="hidden" name="tableId" id="statusTableId">
                    <select name="status" class="form-select" id="statusSelect">
                        <option value="EMPTY">Trống</option>
                        <option value="RESERVED">Đặt trước</option>
                        <option value="SERVING">Đang phục vụ</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                </div>
            </form>
        </div>
    </div>
</th:block>


<th:block layout:fragment="script">
    <script>
        function filterTables() {
            const query = document.getElementById("tableSearch").value.toLowerCase();
            const status = document.getElementById("statusFilter").value;
            const cards = document.querySelectorAll(".table-card");
            cards.forEach(card => {
                const name = card.querySelector(".card-title").innerText.toLowerCase();
                const cardStatus = card.getAttribute("data-status");
                const nameMatch = name.includes(query);
                const statusMatch = !status || status === cardStatus;
                card.style.display = nameMatch && statusMatch ? "block" : "none";
            });
        }

        function handleOrder(button) {
            const tableId = button.dataset.id;
            const status = button.dataset.status;
            if (status !== 'SERVING') {
                const form = document.getElementById('serveForm');
                form.action = `/waiter/tables/${tableId}/force-serving`;
                const modal = new bootstrap.Modal(document.getElementById('confirmServeModal'));
                modal.show();
            } else {
                window.location.href = `/waiter/tables/go-to-order?tableId=${tableId}`;
            }
        }
        function openStatusModal(button) {
            const tableId = button.dataset.id;
            const currentStatus = button.dataset.current;

            document.getElementById("statusTableId").value = tableId;
            document.getElementById("statusSelect").value = currentStatus;

            const form = document.getElementById("statusForm");
            form.action = `/waiter/tables/${tableId}/change-status`;

            const modal = new bootstrap.Modal(document.getElementById("statusModal"));
            modal.show();
        }
    </script>
</th:block>
</html>
